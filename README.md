# windows-container-test

This project demonstrates building a Windows Docker container with Visual Studio, CMake and git, with the objective of being to implement the VFX Reference Platform compliant ASWF build containers from https://github.com/AcademySoftwareFoundation/aswf-docker

## Windows Version Requirements

Docker on Windows requires that containers are built from a base images of the same Windows version (or more specifically Build version) than the system on which they will run. As of Fall 2019 the only Microsoft hosted Azure Pipelines Windows build agent with Container support enabled is running Windows Server Core 2016 Build 1803:

https://github.com/Microsoft/azure-pipelines-image-generation/blob/master/images/win/WindowsContainer1803-Readme.md

These build agents already cache some base images, so to save disk space (both when generating the container and when ultimately using it on the same type of build agent) we will use the following base image:

```
mcr.microsoft.com/windows/servercore:1803
```

Windows versions 1909 and newer lift this restriction and allow Windows hosts to run containters built on older Windows versions:

https://docs.microsoft.com/en-us/windows-insider/at-home/whats-new-wip-at-home-1909

## Setting Up Azure Pipelines

For a more detailed discussion on setting up an Azure DevOps / Azure Pipelines CI environment see [Continuous Integration with Azure DevOps in the ASWF Sample Project](https://github.com/jfpanisset/aswf-sample-project#continuous-integration-with-azure-devops--azure-pipeline). We will use the Azure CLI to create a corresponding Azure DevOps project:

```bash
az extension add --name azure-devops
export AZURE_DEVOPS_EXT_PAT=YOUR_AZDEVOPS_PAT
az devops configure --defaults organization=https://dev.azure.com/AZDEVOPS_ORG_NAME
az devops project create --name AZDEVOPS_PROJECT_NAME --source-control git --visibility public
az devops configure --defaults project=AZDEVOPS_PROJECT_NAME
```

You can update an existing installation of the `azure-devops` extension:

```bash
az extension  update --name azure-devops
```

and list installed extensions and their versions:

```bash
$ az extension list
[
  {
    "extensionType": "whl",
    "name": "azure-devops",
    "version": "0.15.0"
  }
]
```

To specifically get the installed version of the `azure-devops` extension:

```bash
$ az extension list --query "[?name=='azure-devops'].{version:version}"
[
  {
    "version": "0.15.0"
  }
]
```

Create the service connection to the GitHub project:

```bash
export AZURE_DEVOPS_EXT_GITHUB_PAT=YOUR_GITHUB_PAT
az devops service-endpoint github create --github-url https://github.com/GITHUB_ACCOUNT/GITHUB_PROJECT/settings --name GITHUB_PROJECT.github.connection
```

Create the build pipeline:

```bash
export GITHUB_CONNECTION_ID=$(az devops service-endpoint list  --query "[?name=='GITHUB_PROJECT.github.connection'].id" -o tsv)
az pipelines create --name GITHUB_PROJECT.ci --repository GITHUB_USER/GITHUB_PROJECT --branch master --repository-type github --service-connection $GITHUB_CONNECTION_ID --skip-first-run --yml-path /a
zure-pipelines.yml
```

### Using a secret variable for docker hub login

To authenticate against Docker Hub using `docker login` to push the newly built image requires a [Docker Hub Personnal Access Token](https://www.docker.com/blog/docker-hub-new-personal-access-tokens/). Record this PAT in a secure location before dismissing the creation window.

Next save this token to a secret Azure Pipelines secret variable called `DOCKER_HUB_TOKEN`:

```
az pipelines variable create --name DOCKER_HUB_TOKEN --value YOUR_DOCKER_HUB_TOKEN --secret true --allow-override true --pipeline-name GITHUB_PROJECT.ci
```

### Using a service connection with the predefined Docker task

Instead of using `docker login`, we can use the pre-defined `Docker task` in Azure Pipelines. We need to [create a Service Connection with the Azure CLI](https://docs.microsoft.com/en-us/cli/azure/ext/azure-devops/devops/service-endpoint?view=azure-cli-latest#ext-azure-devops-az-devops-service-endpoint-create). Unfortunately [the API isn't completely fleshed out for Docker Hub service endpoints](https://docs.microsoft.com/en-us/azure/devops/cli/service_endpoint?view=azure-devops) and requires gathering a sample JSON request generated by using the GUI, updating it with the desired parameters and feeding that to the command line. The file [az_cli_docker_hub_endpoint.json](az_cli_docker_hub_endpoint.json) can be used to create a valid request:

```bash
sed -e 's/DOCKER_HUB_USER/docker-hub-id/' \
    -e 's/DOCKER_HUB_TOKEN/docker-hub-access-token/' \
    -e 's/DOCKER_HUB_EMAIL/docker-hub-email/' \
    -e 's/DOCKER_HUB_CONNECTION/GITHUB_PROJECT.dockerhub.connection/' \
    docker_hub_endpoint.json | \
az devops service-endpoint create --service-endpoint-configuration /dev/stdin
```

where `name-for-service-endpoint` corresponds to the `containerRegistry` property of the `Docker@2` task in your [azure-pipelines.yml](azure-pipelines.yml) CI configuration file. `az devops ...` reads the output of `sed` via `/dev/stdin` to avoid having to create a temporary file containing cleartext credentials.

Currently `az devops service-endpoint create` creates a service connection which doesn't have the "Allow all pipelines to use this service connection" property set (which you can set when you create a service connection from the web UI). The comments in this [GitHub Issue requesting a feature enhancement](https://github.com/Azure/azure-devops-cli-extension/issues/817) propose the use of a generic API, `az devops invoke ...` as a workaround.

```bash
export DOCKER_HUB_CONNECTION_ID=$(az devops service-endpoint list \
    --query "[?name=='name-of-docker-hub-connection'].id" -o tsv)
sed -e 's/DOCKER_HUB_CONNECTION_ID/'$DOCKER_HUB_CONNECTION_ID'/' \
    -e 's/DOCKER_HUB_CONNECTION/name-of-docker-hub-service-endpoint/' \
    docker_hub_endpoint_auth.json | \
az devops invoke --http-method patch --area build --resource authorizedresources \
    --route-parameters project=GITHUB_PROJECT --api-version 5.0-preview --in-file /dev/stdin --encoding ascii
```


